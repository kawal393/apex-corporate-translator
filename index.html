<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>APEX Corporate Translator</title>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg0:#060a12;
      --bg1:#0a0f1d;
      --card:#0b1220cc;
      --card2:#0c1526cc;
      --stroke:rgba(255,255,255,.08);
      --stroke2:rgba(255,255,255,.12);
      --text:#e9eefc;
      --muted:rgba(233,238,252,.62);
      --muted2:rgba(233,238,252,.42);
      --blue:#3b82f6;
      --blue2:#2563eb;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --chip:rgba(255,255,255,.06);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius:18px;
      --radius2:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 18% 0%, rgba(59,130,246,.22), transparent 55%),
        radial-gradient(900px 600px at 82% 12%, rgba(37,99,235,.16), transparent 52%),
        radial-gradient(1000px 700px at 50% 100%, rgba(255,255,255,.05), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }

    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:18px 14px 28px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 6px 14px;
    }

    .brand{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .dot{
      width:12px;height:12px;border-radius:4px;
      background:linear-gradient(180deg, rgba(59,130,246,1), rgba(37,99,235,1));
      box-shadow:0 0 0 3px rgba(59,130,246,.18);
      flex:0 0 auto;
    }
    .brand h1{
      font-size:14px;margin:0;line-height:1.1;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand .sub{
      font-size:12px;color:var(--muted2);margin-top:2px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .rightchips{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .chip{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      background:var(--chip);
      border:1px solid var(--stroke);
      color:var(--muted);
      display:flex; align-items:center; gap:6px;
    }
    .chip .led{
      width:8px;height:8px;border-radius:50%;
      background:var(--good);
      box-shadow:0 0 0 3px rgba(34,197,94,.16);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
      align-items:start;
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      border-radius:var(--radius2);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .inner{ padding:14px; }

    .title{
      font-size:24px;
      margin:0 0 6px;
      letter-spacing:.2px;
    }
    .desc{ margin:0 0 12px; color:var(--muted); font-size:13px; line-height:1.35; }

    label.small{ display:block; font-size:12px; letter-spacing:.12em; color:var(--muted2); margin:10px 0 6px; text-transform:uppercase; }
    textarea{
      width:100%;
      min-height:160px;
      resize:vertical;
      border-radius:16px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.22);
      color:var(--text);
      padding:12px 12px;
      font-family:var(--mono);
      font-size:13px;
      line-height:1.45;
      outline:none;
    }
    textarea:focus{ border-color:rgba(59,130,246,.55); box-shadow:0 0 0 3px rgba(59,130,246,.14); }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }

    .pdfrow{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      padding:10px 12px;
      border:1px solid var(--stroke);
      border-radius:14px;
      background:rgba(0,0,0,.14);
    }
    .pdfrow b{ font-size:12px; letter-spacing:.12em; color:var(--muted2); text-transform:uppercase; }
    .pdfrow .status{ font-size:12px; color:var(--muted); }
    input[type="file"]{ color:var(--muted); font-size:12px; }

    .hint{
      color:var(--muted2);
      font-size:12px;
      margin-top:8px;
      line-height:1.35;
    }
    .meta{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-top:6px; color:var(--muted2); font-size:12px;
    }

    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    button{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:600;
      font-size:13px;
      cursor:pointer;
    }
    button:hover{ border-color:var(--stroke2); background:rgba(255,255,255,.06); }
    button.primary{
      border-color:rgba(59,130,246,.45);
      background:linear-gradient(180deg, rgba(59,130,246,1), rgba(37,99,235,1));
      box-shadow:0 10px 22px rgba(37,99,235,.25);
    }
    button.primary:hover{ filter:brightness(1.02); }
    button.ghost{ background:transparent; }
    button.small{ padding:9px 10px; font-size:12px; border-radius:12px; }
    button:disabled{ opacity:.45; cursor:not-allowed; }

    .sectionHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .sectionHead h2{
      margin:0;
      font-size:20px;
      letter-spacing:.2px;
    }
    .sectionHead p{
      margin:4px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
      max-width:520px;
    }

    .stats{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:10px;
      margin-top:10px;
    }
    .stat{
      border:1px solid var(--stroke);
      border-radius:16px;
      background:rgba(0,0,0,.16);
      padding:10px 10px;
      min-height:64px;
    }
    .stat .k{ font-size:11px; letter-spacing:.12em; text-transform:uppercase; color:var(--muted2); }
    .stat .v{ margin-top:6px; font-size:15px; font-weight:800; }

    .alert{
      margin-top:10px;
      border:1px solid var(--stroke);
      border-radius:16px;
      background:rgba(0,0,0,.18);
      padding:12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .alertLeft{ min-width:0; }
    .alertTitle{
      display:flex; align-items:center; gap:8px;
      font-weight:900;
      letter-spacing:.04em;
      font-size:13px;
      margin-bottom:6px;
    }
    .badge{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      font-size:12px;
      font-weight:800;
      white-space:nowrap;
      align-self:flex-start;
    }
    .pill{
      width:10px;height:10px;border-radius:50%;
      background:var(--warn);
      box-shadow:0 0 0 3px rgba(245,158,11,.14);
    }
    .alertText{ color:var(--muted); font-size:13px; line-height:1.35; }

    .verdictBox{
      margin-top:10px;
      border:1px solid var(--stroke);
      border-radius:16px;
      background:rgba(0,0,0,.16);
      padding:12px;
    }
    .verdictTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .verdictTop .h{
      font-size:12px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--muted2);
      font-weight:900;
    }
    ul{
      margin:0;
      padding-left:18px;
      color:var(--text);
      font-size:13px;
      line-height:1.45;
    }
    li{ margin:7px 0; color:var(--muted); }
    li strong{ color:var(--text); }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }

    .foot{
      margin-top:10px;
      color:var(--muted2);
      font-size:12px;
      line-height:1.4;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(15,23,42,.92);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 12px;
      border-radius:14px;
      color:var(--text);
      font-size:13px;
      display:none;
      box-shadow:0 16px 42px rgba(0,0,0,.55);
      max-width:min(92vw, 560px);
      z-index:9999;
    }

    /* Responsive: stack columns on smaller screens */
    @media (max-width: 920px){
      .grid{ grid-template-columns:1fr; }
      textarea{ min-height:190px; }
      .stats{ grid-template-columns:1fr; }
      .stat{ min-height:auto; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div style="min-width:0">
          <h1>APEX Corporate Translator</h1>
          <div class="sub">Translate corporate language into consequences — fast verdict, no spin.</div>
          <div style="font-size:11px;color:rgba(233,238,252,.45);margin-top:3px;">build: v10.10</div>
        </div>
      </div>
      <div class="rightchips">
        <div class="chip"><span class="led"></span>Local • No upload</div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="inner">
          <h2 class="title">Paste the message</h2>
          <p class="desc">Paste an internal email, Slack message, or leadership announcement. For best results, include the subject + opening paragraphs.</p>

          <label class="small" for="input">Message</label>
          <textarea id="input" placeholder="Paste corporate email / announcement here..."></textarea>

          <div class="row">
            <div class="pdfrow">
              <b>PDF Upload</b>
              <input id="pdfFile" type="file" accept="application/pdf" />
              <span id="pdfStatus" class="status">No PDF loaded</span>
            </div>
            <div class="meta">
              <span id="charCount">0 chars</span>
            </div>
          </div>

          <div class="hint">
            Tip: include words like “operating model”, “over the coming weeks”, “align resources”, “streamline”, “organizational adjustments”.
          </div>

          <div class="btns">
            <button class="primary" id="runBtn">Translate with APEX</button>
            <button id="examplesBtn">See Real Examples</button>
            <button class="ghost" id="clearBtn">Clear</button>
          </div>

          <div class="foot">
            Built to decode language patterns that commonly appear before restructures, layoffs, and role changes.
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="inner">
          <div class="sectionHead">
            <div>
              <h2 style="margin:0;">Verdict</h2>
              <p>APEX outputs exactly five bullets: what’s happening, why now, what’s next, who’s exposed, what to do.</p>
            </div>
          </div>

          <div class="stats">
            <div class="stat">
              <div class="k">Status</div>
              <div class="v" id="statusVal">—</div>
            </div>
            <div class="stat">
              <div class="k">Confidence</div>
              <div class="v" id="confVal">—</div>
            </div>
            <div class="stat">
              <div class="k">Signals</div>
              <div class="v" id="signalsVal">—</div>
            </div>
          </div>

          <div class="alert">
            <div class="alertLeft">
              <div class="alertTitle"><span class="pill" id="pill"></span> APEX ALERT</div>
              <div class="alertText" id="alertText">Paste a message and run APEX to get a verdict.</div>
            </div>
            <div class="badge" id="statusBadge">Status: —</div>
          </div>

          <div class="verdictBox">
            <div class="verdictTop">
              <div class="h">APEX VERDICT (EXACTLY 5 BULLETS)</div>
              <button class="small" id="copyBtn">Copy Verdict</button>
            </div>
            <ul id="verdictList">
              <li>No verdict yet.</li>
            </ul>

            <div class="actions">
              <button id="pdfBtn">Download PDF</button>
              <button id="shareBtn">Share Link</button>
              <button id="saveBtn">Save History</button>
              <button id="viewBtn">View History</button>
            </div>

            <div class="foot">
              Free now. PDF export, share links, and history work locally (no account). If you later add billing, keep the UI and flip the switches.
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ---------- utilities ----------
    const $ = (id) => document.getElementById(id);

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=> t.style.display="none", 2400);
    }

    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

    // ---------- APEX signal library ----------
    // Weights tuned for corporate-meaning patterns.
    const SIGNALS = [
      { key:"roles will be eliminated", w:9, tag:"explicit job elimination" },
      { key:"impacted employees", w:7, tag:"impact targeting" },
      { key:"reduction in force", w:10, tag:"RIF" },
      { key:"layoff", w:10, tag:"layoff" },
      { key:"reducing costs", w:6, tag:"cost reduction" },
      { key:"cost reduction", w:6, tag:"cost reduction" },
      { key:"organizational adjustments", w:5, tag:"org change" },
      { key:"operating model", w:5, tag:"operating model shift" },
      { key:"restructur", w:6, tag:"restructure" }, // matches restructure/restructuring
      { key:"realign", w:5, tag:"realignment" },
      { key:"align resources", w:4, tag:"resource alignment" },
      { key:"streamline", w:4, tag:"streamline" },
      { key:"efficiency", w:3, tag:"efficiency push" },
      { key:"accountability", w:2, tag:"accountability framing" },
      { key:"focus resources", w:3, tag:"focus shift" },
      { key:"strategic priorities", w:3, tag:"priority reshuffle" },
      { key:"over the coming weeks", w:2, tag:"near-term window" },
      { key:"managers will share", w:2, tag:"details deferred" },
      { key:"as they become available", w:2, tag:"details deferred" },
      { key:"flexibility", w:1, tag:"compliance language" },
      { key:"adaptability", w:1, tag:"compliance language" }
    ];

    function analyze(text){
      const t = (text || "").toLowerCase();
      const hits = [];
      let score = 0;

      for(const s of SIGNALS){
        if(t.includes(s.key)){
          hits.push(s);
          score += s.w;
        }
      }

      // Status bands
      let status = "WATCH";
      if(score >= 18) status = "CRITICAL";
      else if(score >= 10) status = "HIGH";
      else status = "WATCH";

      // Confidence heuristics
      // more hits + explicit language = higher confidence
      const explicit = t.includes("roles will be eliminated") || t.includes("reduction in force") || t.includes("layoff") || t.includes("impacted employees");
      let confidence = "Low";
      if(score >= 18 || (explicit && hits.length >= 2)) confidence = "High";
      else if(score >= 10 || hits.length >= 4) confidence = "Medium";

      // Exactly 5 bullets, always
      const bullets = buildBullets(t, status, confidence, hits, score);

      return { status, confidence, hits, score, bullets };
    }

    function buildBullets(t, status, confidence, hits, score){
      const subjectLine = (() => {
        // Try to extract "Subject:" line if present, else first 90 chars
        const lines = (t || "").split("\n").map(x=>x.trim()).filter(Boolean);
        const subj = lines.find(l => l.startsWith("subject:"));
        if(subj) return subj.replace(/^subject:\s*/,"").slice(0,90);
        const first = (lines[0] || "").slice(0,90);
        return first || "Update";
      })();

      const hasExplicit = t.includes("roles will be eliminated") || t.includes("reduction in force") || t.includes("layoff");

      const whatHappening =
        status === "CRITICAL"
          ? `Headline: "${subjectLine}" is a ${status} change signal.`
          : status === "HIGH"
            ? `Headline: "${subjectLine}" signals elevated change risk (HIGH).`
            : `Headline: "${subjectLine}" looks routine/low-signal on its face (WATCH).`;

      const whyNow =
        status === "CRITICAL"
          ? (hasExplicit
              ? `Core meaning: explicit risk detected (role cuts / eliminations) — treat as layoffs/reorg now.`
              : `Core meaning: strong reorg language + “details later” pattern — role impact is plausible.`)
          : status === "HIGH"
            ? `Core meaning: resource alignment / operating model shift — reporting-line or priority changes likely.`
            : `Core meaning: informational notice / process update — no structural change implied from this text alone.`;

      const nextStep =
        status === "CRITICAL"
          ? `Next: decisions lock fast (1–6 weeks). Expect manager meetings, role mapping, and individual notices.`
          : status === "HIGH"
            ? `Next: manager-led meetings + scope clarification; decisions likely form within weeks.`
            : `Next: proceed as normal; watch for follow-up emails introducing “efficiency”, “realignment”, or “org adjustments”.`;

      const exposed =
        status === "CRITICAL"
          ? `Exposure: duplicated functions, non-core teams, and roles tied to “efficiency/streamline” initiatives.`
          : status === "HIGH"
            ? `Exposure: teams outside stated “core priorities”, or functions being “streamlined” / centralized.`
            : `Exposure: low — unless your function is already under budget pressure or “non-core” narrative.`;

      const doNow =
        status === "CRITICAL"
          ? `Do now: ask 3 specifics today — (1) scope, (2) reporting line, (3) timeline. Update your evidence trail (emails/notes/dates).`
          : status === "HIGH"
            ? `Do now: clarify (1) scope changes, (2) reporting line, (3) role-impact timeline. Save copies of messages.`
            : `Do now: save for context; escalate only if later messages add change language.`;

      return [whatHappening, whyNow, nextStep, exposed, doNow];
    }

    function setPill(status){
      const pill = $("pill");
      pill.style.background =
        status === "CRITICAL" ? "var(--bad)" :
        status === "HIGH" ? "var(--warn)" : "rgba(148,163,184,.9)";
      pill.style.boxShadow =
        status === "CRITICAL" ? "0 0 0 3px rgba(239,68,68,.14)" :
        status === "HIGH" ? "0 0 0 3px rgba(245,158,11,.14)" : "0 0 0 3px rgba(148,163,184,.14)";
    }

    function render(res){
      $("statusVal").textContent = res.status;
      $("confVal").textContent = res.confidence;
      $("signalsVal").textContent = `${res.hits.length} (score ${res.score})`;
      $("statusBadge").textContent = `Status: ${res.status}`;
      setPill(res.status);

      const alertLine =
        `Status: ${res.status} · Confidence: ${res.confidence} · Signals: ${res.hits.length} (score ${res.score}) — ` +
        (res.status==="CRITICAL"
          ? "Major change risk. Reorg and/or role impact possible. Act now."
          : res.status==="HIGH"
            ? "Change risk elevated. Clarify scope + reporting line."
            : "Low risk / likely informational.");

      $("alertText").textContent = alertLine;

      const ul = $("verdictList");
      ul.innerHTML = "";
      res.bullets.forEach(b=>{
        const li = document.createElement("li");
        li.innerHTML = escapeHtml(b);
        ul.appendChild(li);
      });

      window.__lastResult = res;
    }

    function getVerdictText(res){
      const lines = [];
      lines.push(`APEX Corporate Translator — Verdict`);
      lines.push(`Status: ${res.status} | Confidence: ${res.confidence} | Signals: ${res.hits.length} (score ${res.score})`);
      lines.push(``);
      lines.push(`APEX ALERT`);
      lines.push(`Status: ${res.status} · Confidence: ${res.confidence} · Signals: ${res.hits.length} (score ${res.score})`);
      lines.push(``);
      lines.push(`Verdict (exactly 5 bullets)`);
      res.bullets.forEach((b,i)=> lines.push(`${i+1}. ${b}`));
      lines.push(``);
      lines.push(`Generated locally in your browser. No text is uploaded by this page.`);
      return lines.join("\n");
    }

    // ---------- PDF extraction ----------
    // Configure PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.js";

    async function extractTextFromPDF(file){
      const data = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data }).promise;

      let full = "";
      const maxPages = Math.min(pdf.numPages, 12); // keep it safe/fast
      for(let i=1;i<=maxPages;i++){
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const strings = content.items.map(it => it.str).filter(Boolean);
        const pageText = strings.join(" ").replace(/\s+/g," ").trim();
        if(pageText) full += pageText + "\n\n";
      }
      return full.trim();
    }

    // ---------- share links ----------
    function b64urlEncode(str){
      const b64 = btoa(unescape(encodeURIComponent(str)));
      return b64.replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
    }
    function b64urlDecode(b64url){
      const b64 = b64url.replaceAll("-","+").replaceAll("_","/") + "===".slice((b64url.length+3)%4);
      return decodeURIComponent(escape(atob(b64)));
    }

    function setFromHashIfPresent(){
      const hash = location.hash || "";
      const m = hash.match(/#t=([A-Za-z0-9\-_]+)/);
      if(!m) return;
      try{
        const txt = b64urlDecode(m[1]);
        $("input").value = txt;
        $("charCount").textContent = `${txt.length} chars`;
        const res = analyze(txt);
        render(res);
        toast("Loaded from share link");
      }catch(e){
        console.error(e);
        toast("Invalid share link");
      }
    }

    // ---------- local history ----------
    const HIST_KEY = "apex_history_v1";

    function loadHistory(){
      try{
        return JSON.parse(localStorage.getItem(HIST_KEY) || "[]");
      }catch{
        return [];
      }
    }
    function saveHistory(arr){
      localStorage.setItem(HIST_KEY, JSON.stringify(arr.slice(-50)));
    }

    function historyModal(items){
      const html = items.map((it, idx)=>`
        <div style="border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:10px;margin:10px 0;background:rgba(0,0,0,.20)">
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <div style="font-weight:800">${escapeHtml(it.status)} <span style="color:rgba(233,238,252,.55);font-weight:600">· ${escapeHtml(it.confidence)} · score ${it.score}</span></div>
            <div style="color:rgba(233,238,252,.45);font-size:12px">${escapeHtml(new Date(it.ts).toLocaleString())}</div>
          </div>
          <div style="color:rgba(233,238,252,.62);font-family:${varMono()};font-size:12px;margin-top:8px;white-space:pre-wrap">${escapeHtml(it.preview)}</div>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button data-idx="${idx}" class="small" style="padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);color:#e9eefc;font-weight:700;cursor:pointer">Load</button>
          </div>
        </div>
      `).join("");

      const overlay = document.createElement("div");
      overlay.style.position="fixed";
      overlay.style.inset="0";
      overlay.style.background="rgba(0,0,0,.55)";
      overlay.style.zIndex="9998";
      overlay.style.display="grid";
      overlay.style.placeItems="center";
      overlay.innerHTML = `
        <div style="width:min(94vw,860px);max-height:82vh;overflow:auto;background:rgba(15,23,42,.96);border:1px solid rgba(255,255,255,.12);border-radius:18px;box-shadow:0 24px 80px rgba(0,0,0,.6);padding:14px">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;position:sticky;top:0;background:rgba(15,23,42,.96);padding:6px 0">
            <div style="font-weight:900;font-size:16px">History</div>
            <button id="closeHist" class="small" style="padding:8px 10px;border-radius:12px;">Close</button>
          </div>
          <div style="color:rgba(233,238,252,.55);font-size:12px;margin-bottom:10px">Stored locally in your browser.</div>
          ${items.length ? html : `<div style="color:rgba(233,238,252,.65);padding:10px">No history yet.</div>`}
        </div>
      `;
      document.body.appendChild(overlay);

      overlay.querySelector("#closeHist").addEventListener("click", ()=> overlay.remove());
      overlay.addEventListener("click", (e)=>{ if(e.target===overlay) overlay.remove(); });

      overlay.querySelectorAll("button[data-idx]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const i = Number(btn.getAttribute("data-idx"));
          const it = items[i];
          $("input").value = it.text;
          $("charCount").textContent = `${it.text.length} chars`;
          render(analyze(it.text));
          overlay.remove();
          toast("Loaded from history");
        });
      });
    }

    function varMono(){ return "ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace"; }

    // ---------- events ----------
    $("input").addEventListener("input", ()=>{
      const v = $("input").value || "";
      $("charCount").textContent = `${v.length} chars`;
    });

    $("runBtn").addEventListener("click", ()=>{
      const txt = ($("input").value || "").trim();
      if(!txt){ toast("Paste a message first"); return; }
      const res = analyze(txt);
      render(res);
      toast("Verdict generated");
    });

    $("clearBtn").addEventListener("click", ()=>{
      $("input").value = "";
      $("charCount").textContent = "0 chars";
      $("pdfFile").value = "";
      $("pdfStatus").textContent = "No PDF loaded";

      $("statusVal").textContent = "—";
      $("confVal").textContent = "—";
      $("signalsVal").textContent = "—";
      $("statusBadge").textContent = "Status: —";
      $("alertText").textContent = "Paste a message and run APEX to get a verdict.";
      $("verdictList").innerHTML = "<li>No verdict yet.</li>";
      setPill("WATCH");
      window.__lastResult = null;

      toast("Cleared");
    });

    $("examplesBtn").addEventListener("click", ()=>{
      const ex = [
`Subject: Important Update on Our Operating Model
As we navigate a dynamic market environment, we’re evaluating opportunities to better align resources with strategic priorities.
Over the coming weeks we will implement organizational adjustments designed to streamline workflows.
Additional details will be shared by your managers as they become available.
Thank you for your continued commitment and adaptability.`,
`Subject: FYI — Office Closed Friday
Team, reminder that the office will be closed this Friday for scheduled maintenance. Please work from home if needed. Thanks.`,
`Subject: Organizational Changes
Due to current market conditions, we are reducing costs and restructuring teams. Some roles will be eliminated. Impacted employees will be contacted this week. Thank you.`
      ];
      const txt = ex[Math.floor(Math.random()*ex.length)];
      $("input").value = txt;
      $("charCount").textContent = `${txt.length} chars`;
      render(analyze(txt));
      toast("Example loaded");
    });

    $("copyBtn").addEventListener("click", async ()=>{
      const res = window.__lastResult;
      if(!res){ toast("Run a verdict first"); return; }
      const out = getVerdictText(res);
      try{
        await navigator.clipboard.writeText(out);
        toast("Copied verdict");
      }catch{
        // fallback
        const ta = document.createElement("textarea");
        ta.value = out;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        toast("Copied verdict");
      }
    });

    $("pdfBtn").addEventListener("click", ()=>{
      const res = window.__lastResult;
      if(!res){ toast("Run a verdict first"); return; }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:"pt", format:"a4" });

      const margin = 44;
      const w = doc.internal.pageSize.getWidth();
      let y = 56;

      doc.setFont("helvetica", "bold");
      doc.setFontSize(16);
      doc.text("APEX Corporate Translator — Verdict", margin, y);
      y += 18;

      doc.setFont("helvetica", "normal");
      doc.setFontSize(11);
      doc.text(`Status: ${res.status}   |   Confidence: ${res.confidence}   |   Signals: ${res.hits.length} (score ${res.score})`, margin, y);
      y += 22;

      doc.setFont("helvetica", "bold");
      doc.text("APEX ALERT", margin, y);
      y += 14;

      doc.setFont("helvetica", "normal");
      const alertLine =
        `Status: ${res.status} · Confidence: ${res.confidence} · Signals: ${res.hits.length} (score ${res.score})`;
      const alertWrap = doc.splitTextToSize(alertLine, w - margin*2);
      doc.text(alertWrap, margin, y);
      y += alertWrap.length * 14 + 12;

      doc.setFont("helvetica", "bold");
      doc.text("Verdict (exactly 5 bullets)", margin, y);
      y += 16;

      doc.setFont("helvetica", "normal");
      doc.setFontSize(11);
      res.bullets.forEach((b, i)=>{
        const line = `${i+1}. ${b}`;
        const wrap = doc.splitTextToSize(line, w - margin*2);
        if(y + wrap.length*14 > doc.internal.pageSize.getHeight() - 70){
          doc.addPage();
          y = 56;
        }
        doc.text(wrap, margin, y);
        y += wrap.length * 14 + 8;
      });

      y += 8;
      doc.setFontSize(9);
      doc.setTextColor(90);
      doc.text("Generated locally in your browser. No text is uploaded by this page.", margin, doc.internal.pageSize.getHeight() - 44);

      doc.save("apex-verdict.pdf");
      toast("PDF downloaded");
    });

    $("shareBtn").addEventListener("click", async ()=>{
      const txt = ($("input").value || "").trim();
      if(!txt){ toast("Paste a message first"); return; }
      const token = b64urlEncode(txt.slice(0, 9000)); // cap
      const url = `${location.origin}${location.pathname}#t=${token}`;
      try{
        await navigator.clipboard.writeText(url);
        toast("Share link copied");
      }catch{
        prompt("Copy share link:", url);
      }
    });

    $("saveBtn").addEventListener("click", ()=>{
      const txt = ($("input").value || "").trim();
      const res = window.__lastResult;
      if(!txt || !res){ toast("Run a verdict first"); return; }

      const items = loadHistory();
      items.push({
        ts: Date.now(),
        text: txt,
        status: res.status,
        confidence: res.confidence,
        score: res.score,
        preview: txt.slice(0, 260) + (txt.length>260 ? "…" : "")
      });
      saveHistory(items);
      toast("Saved to history");
    });

    $("viewBtn").addEventListener("click", ()=>{
      const items = loadHistory().reverse();
      historyModal(items);
    });

    // PDF upload -> extract -> put text into textarea (optional: auto-run verdict)
    $("pdfFile").addEventListener("change", async ()=>{
      const f = $("pdfFile").files && $("pdfFile").files[0];
      if(!f){ $("pdfStatus").textContent = "No PDF loaded"; return; }
      $("pdfStatus").textContent = "Extracting…";
      try{
        const text = await extractTextFromPDF(f);
        if(!text){
          $("pdfStatus").textContent = "PDF loaded (no text found)";
          toast("PDF has no extractable text");
          return;
        }
        $("pdfStatus").textContent = `PDF loaded: ${f.name}`;
        $("input").value = text.slice(0, 12000);
        $("charCount").textContent = `${$("input").value.length} chars`;
        // Optional auto-run:
        render(analyze($("input").value));
        toast("PDF text extracted");
      }catch(e){
        console.error(e);
        $("pdfStatus").textContent = "PDF failed (try another file)";
        toast("Failed to read PDF");
      }
    });

    // Load shared hash on open
    setFromHashIfPresent();
  </script>
</body>
</html>
