<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>APEX Corporate Translator</title>
  <meta name="description" content="Translate corporate language into consequences — fast verdict, no spin." />

  <style>
    :root{
      --bg:#060b12;
      --panel:#0b1320;
      --panel2:#0a111d;
      --stroke:rgba(255,255,255,.08);
      --stroke2:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --muted2:rgba(255,255,255,.48);
      --blue1:#3b82f6;
      --blue2:#2563eb;
      --green:#22c55e;
      --amber:#f59e0b;
      --red:#ef4444;
      --shadow: 0 24px 60px rgba(0,0,0,.55);
      --radius:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 650px at 20% 8%, rgba(59,130,246,.25), transparent 55%),
        radial-gradient(900px 520px at 90% 20%, rgba(139,92,246,.14), transparent 55%),
        linear-gradient(180deg, #070d16 0%, #050912 70%, #040711 100%);
      color:var(--text);
      min-height:100vh;
      padding:18px 14px 28px;
    }
    .wrap{max-width:1120px;margin:0 auto}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 8px 18px;
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;letter-spacing:.2px}
    .logo{
      width:26px;height:26px;border-radius:9px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), transparent 55%),
                  linear-gradient(180deg, rgba(59,130,246,.85), rgba(37,99,235,.85));
      box-shadow: 0 14px 30px rgba(37,99,235,.18);
      border:1px solid rgba(255,255,255,.12);
    }
    .brand small{display:block;color:var(--muted);font-weight:500;margin-top:2px}
    .live{
      display:flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12px;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--green);box-shadow:0 0 0 6px rgba(34,197,94,.10)}
    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:18px 18px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background:
        radial-gradient(900px 320px at 20% 10%, rgba(59,130,246,.22), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    }
    .hTitle{
      font-size:18px;font-weight:700;margin:0 0 6px;letter-spacing:.2px
    }
    .hSub{
      margin:0;color:var(--muted);font-size:13px;line-height:1.35
    }
    .body{padding:16px 18px 18px}
    .label{font-size:12px;color:var(--muted);margin:0 0 8px}
    textarea{
      width:100%;
      min-height:190px;
      resize:vertical;
      font-family:var(--mono);
      font-size:13px;
      line-height:1.45;
      color:rgba(255,255,255,.88);
      padding:14px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      outline:none;
    }
    textarea:focus{border-color:rgba(59,130,246,.55); box-shadow: 0 0 0 6px rgba(59,130,246,.10)}
    .row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top:12px;
    }
    .btn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.88);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:active{transform: translateY(1px)}
    .btnPrimary{
      background: linear-gradient(180deg, rgba(59,130,246,.95), rgba(37,99,235,.92));
      border-color: rgba(59,130,246,.55);
      box-shadow: 0 16px 30px rgba(37,99,235,.20);
    }
    .btnPrimary:hover{background: linear-gradient(180deg, rgba(66,153,255,.98), rgba(37,99,235,.95))}
    .btnGhost{background: rgba(255,255,255,.03)}
    .btnSmall{
      padding:9px 10px; font-size:12px; border-radius:12px; font-weight:700;
    }
    .help{
      margin-top:10px;
      color:var(--muted2);
      font-size:12px;
      line-height:1.35;
    }
    .pdfRow{
      display:flex; align-items:center; gap:12px; flex-wrap:wrap;
      margin-top:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.16);
    }
    .pdfRow label{
      font-size:12px;color:var(--muted);font-weight:700;
    }
    .fileName{
      font-size:12px;color:rgba(255,255,255,.75);
      max-width:360px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:rgba(255,255,255,.80);
    }
    .metrics{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:10px;
      margin-top:12px;
    }
    .metric{
      padding:12px 12px;
      border-radius:18px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.08);
    }
    .metric .k{font-size:11px;color:var(--muted);letter-spacing:.18em;text-transform:uppercase}
    .metric .v{font-size:16px;font-weight:800;margin-top:6px}
    .metric .v small{font-size:12px;color:var(--muted);font-weight:700}
    .alertBox{
      margin-top:12px;
      padding:12px 12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .alertTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .alertTitle{
      display:flex; align-items:center; gap:10px;
      font-weight:900; letter-spacing:.08em; text-transform:uppercase; font-size:12px;
    }
    .alertDot{
      width:10px;height:10px;border-radius:999px;background:var(--amber);
      box-shadow:0 0 0 6px rgba(245,158,11,.10);
    }
    .badge{
      padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .badge.red{background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.25)}
    .badge.amber{background: rgba(245,158,11,.10); border-color: rgba(245,158,11,.25)}
    .badge.green{background: rgba(34,197,94,.10); border-color: rgba(34,197,94,.25)}
    .badge.gray{background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.10)}
    .alertText{
      margin-top:8px; color:rgba(255,255,255,.82); font-size:13px; line-height:1.4;
    }
    .verdictBox{
      margin-top:12px;
      padding:12px 12px 4px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
    }
    .vHead{
      font-size:11px;color:var(--muted);
      letter-spacing:.18em;text-transform:uppercase;
      margin-bottom:8px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    ul{
      margin:0;
      padding:0 0 0 18px;
      color:rgba(255,255,255,.86);
      font-size:13px;
      line-height:1.45;
    }
    li{margin:8px 0}
    .actions{
      display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;
    }
    .footerNote{
      margin-top:10px;
      color:var(--muted2);
      font-size:12px;
      line-height:1.35;
    }
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(0,0,0,.75);
      border:1px solid rgba(255,255,255,.14);
      padding:10px 12px;
      border-radius:999px;
      color:rgba(255,255,255,.88);
      font-size:13px;
      box-shadow: 0 20px 40px rgba(0,0,0,.45);
      display:none;
      z-index:9999;
    }
    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9998;
    }
    .modal{
      width:min(860px, 100%);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .modalHead b{font-size:13px;letter-spacing:.14em;text-transform:uppercase}
    .modalBody{padding:14px 16px; color:rgba(255,255,255,.84)}
    .exampleGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .ex{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius:16px;
      padding:12px 12px;
    }
    .exTitle{font-weight:900;margin:0 0 6px}
    .exText{
      margin:0;
      font-family:var(--mono);
      font-size:12px;
      color:rgba(255,255,255,.78);
      white-space:pre-wrap;
      line-height:1.4;
    }
    .monoTiny{font-family:var(--mono); font-size:12px; color:rgba(255,255,255,.74)}
  </style>

  <!-- pdf.js for extracting text from uploaded PDFs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.js"></script>

  <!-- jsPDF for exporting verdict to PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div>APEX Corporate Translator</div>
          <small>Translate corporate language into consequences — fast verdict, no spin.</small>
        </div>
      </div>
      <div class="live"><span class="dot"></span> Live • Free to use</div>
    </div>

    <div class="grid">
      <!-- LEFT: INPUT -->
      <section class="card">
        <div class="cardHeader">
          <h2 class="hTitle">Paste the message</h2>
          <p class="hSub">Paste an internal email, Slack message, or leadership announcement. For best results, include the subject + opening paragraphs.</p>
        </div>
        <div class="body">
          <p class="label">Message</p>
          <textarea id="input" placeholder="Paste corporate email / announcement here..."></textarea>

          <div class="pdfRow">
            <label for="pdfFile">PDF Upload</label>
            <input id="pdfFile" type="file" accept="application/pdf" />
            <span class="fileName" id="pdfName">No PDF loaded</span>
            <span class="pill" id="pdfStatus">—</span>
          </div>

          <div class="help">
            Tip: include words like “operating model”, “over the coming weeks”, “align resources”, “streamline”, “organizational adjustments”.
          </div>

          <div class="row">
            <button class="btn btnPrimary" id="runBtn">Translate with APEX</button>
            <button class="btn btnGhost" id="examplesBtn">See Real Examples</button>
            <button class="btn btnGhost" id="clearBtn">Clear</button>
          </div>

          <div class="footerNote">
            Built to decode language patterns that commonly appear before restructures, layoffs, and role changes.
          </div>
        </div>
      </section>

      <!-- RIGHT: OUTPUT -->
      <section class="card">
        <div class="cardHeader">
          <h2 class="hTitle">Verdict</h2>
          <p class="hSub">APEX outputs exactly five bullets: what’s happening, why now, what’s next, who’s exposed, what to do.</p>
        </div>

        <div class="body">
          <div class="metrics">
            <div class="metric">
              <div class="k">APEX Status</div>
              <div class="v" id="statusVal">—</div>
            </div>
            <div class="metric">
              <div class="k">Confidence</div>
              <div class="v" id="confVal">—</div>
            </div>
            <div class="metric">
              <div class="k">Signals</div>
              <div class="v"><span id="sigVal">—</span> <small id="scoreVal"></small></div>
            </div>
          </div>

          <div class="alertBox">
            <div class="alertTop">
              <div class="alertTitle"><span class="alertDot" id="alertDot"></span> APEX ALERT</div>
              <span class="badge gray" id="badge">Status: —</span>
            </div>
            <div class="alertText" id="alertText">Paste a message and run APEX to get a verdict.</div>
          </div>

          <div class="verdictBox">
            <div class="vHead">
              <span>APEX Verdict (Exactly 5 bullets)</span>
              <button class="btn btnSmall" id="copyBtn">Copy Verdict</button>
            </div>
            <ul id="bullets">
              <li>No verdict yet.</li>
            </ul>
          </div>

          <div class="actions">
            <button class="btn btnSmall" id="downloadPdfBtn">Download PDF</button>
            <button class="btn btnSmall" id="shareBtn">Share Link</button>
            <button class="btn btnSmall" id="saveBtn">Save History</button>
            <button class="btn btnSmall" id="viewHistoryBtn">View History</button>
          </div>

          <div class="footerNote">
            Free now. PDF export, share links, and history work locally (no account). If you later add billing, keep the UI and flip the switches.
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Examples modal -->
  <div class="modalBackdrop" id="modalBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Examples">
      <div class="modalHead">
        <b>Real Examples</b>
        <button class="btn btnSmall" id="closeModal">Close</button>
      </div>
      <div class="modalBody">
        <div class="exampleGrid" id="exampleGrid"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">—</div>

  <script>
    // ---------- Utilities ----------
    const $ = (id) => document.getElementById(id);

    function showToast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(showToast._timer);
      showToast._timer = setTimeout(()=>{ t.style.display="none"; }, 2200);
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function normalize(text){
      return (text || "")
        .replace(/\s+/g," ")
        .replace(/[“”]/g,'"')
        .replace(/[’]/g,"'")
        .trim();
    }

    function setStatusUI(status){
      const badge = $("badge");
      const dot = $("alertDot");

      badge.classList.remove("red","amber","green","gray");
      dot.style.background = "var(--amber)";
      dot.style.boxShadow = "0 0 0 6px rgba(245,158,11,.10)";

      if(status === "CRITICAL"){
        badge.classList.add("red");
        dot.style.background = "var(--red)";
        dot.style.boxShadow = "0 0 0 6px rgba(239,68,68,.10)";
      } else if(status === "HIGH"){
        badge.classList.add("amber");
        dot.style.background = "var(--amber)";
        dot.style.boxShadow = "0 0 0 6px rgba(245,158,11,.10)";
      } else if(status === "WATCH"){
        badge.classList.add("green");
        dot.style.background = "var(--green)";
        dot.style.boxShadow = "0 0 0 6px rgba(34,197,94,.10)";
      } else {
        badge.classList.add("gray");
      }
      badge.textContent = "Status: " + status;
    }

    // ---------- Signal Engine (local heuristic) ----------
    const SIGNALS = [
      { phrase: "operating model", w: 4 },
      { phrase: "organizational adjustments", w: 4 },
      { phrase: "restructure", w: 5 },
      { phrase: "restructuring", w: 5 },
      { phrase: "realignment", w: 4 },
      { phrase: "streamline", w: 4 },
      { phrase: "align resources", w: 3 },
      { phrase: "efficiency", w: 3 },
      { phrase: "cost reduction", w: 4 },
      { phrase: "reduce costs", w: 4 },
      { phrase: "headcount", w: 5 },
      { phrase: "role elimination", w: 5 },
      { phrase: "roles will be eliminated", w: 6 },
      { phrase: "impacted employees", w: 5 },
      { phrase: "priority shifts", w: 3 },
      { phrase: "strategic priorities", w: 2 },
      { phrase: "coming weeks", w: 2 },
      { phrase: "over the coming weeks", w: 2 },
      { phrase: "additional details will be shared", w: 3 },
      { phrase: "as they become available", w: 2 },
      { phrase: "dynamic environment", w: 2 },
      { phrase: "flexibility", w: 2 },
      { phrase: "adaptability", w: 2 },
      { phrase: "focus on core", w: 3 },
      { phrase: "optimize", w: 2 },
      { phrase: "consolidate", w: 3 },
      { phrase: "freeze hiring", w: 4 },
      { phrase: "hiring freeze", w: 4 },
      { phrase: "redundancy", w: 5 },
      { phrase: "reduction", w: 3 },
      { phrase: "reduce workforce", w: 6 },
      { phrase: "severance", w: 4 }
    ];

    function scoreText(text){
      const t = text.toLowerCase();
      let hits = [];
      let score = 0;
      for(const s of SIGNALS){
        if(t.includes(s.phrase)){
          hits.push(s);
          score += s.w;
        }
      }
      // Extra: explicit high-risk words
      const explicit = ["layoff","layoffs","terminated","termination","redundant","redundancies"];
      for(const w of explicit){
        if(t.includes(w)){
          hits.push({phrase:w, w:6});
          score += 6;
        }
      }
      // de-dupe phrases
      const seen = new Set();
      hits = hits.filter(h=>{
        if(seen.has(h.phrase)) return false;
        seen.add(h.phrase);
        return true;
      });

      const signals = hits.length;

      // Status thresholds tuned for your screenshots:
      // 0-2 WATCH, 3-6 HIGH, 7+ CRITICAL OR high explicit.
      const hasExplicit = explicit.some(w => t.includes(w)) || t.includes("roles will be eliminated") || t.includes("impacted employees");
      let status = "WATCH";
      if(signals >= 7 || score >= 18 || hasExplicit) status = "CRITICAL";
      else if(signals >= 3 || score >= 10) status = "HIGH";
      else status = "WATCH";

      // Confidence from signal density and explicitness
      let conf = "Low";
      if(status === "CRITICAL") conf = (signals >= 6 || hasExplicit) ? "High" : "Medium";
      else if(status === "HIGH") conf = (signals >= 5) ? "High" : "Medium";
      else conf = (signals <= 1) ? "Low" : "Medium";

      return { status, conf, signals, score, hits };
    }

    function buildVerdict(text, meta){
      // Exactly 5 bullets.
      const t = text.toLowerCase();

      // headline extraction: look for "Subject:" line if present
      let headline = "This message signals a change event.";
      const m = text.match(/subject:\s*(.+)/i);
      if(m && m[1]){
        const subj = m[1].trim().slice(0, 120);
        headline = `"${subj}" is a ${meta.status} change signal.`;
      } else {
        if(meta.status === "WATCH") headline = "This looks informational, not structural change.";
        if(meta.status === "HIGH") headline = "This signals elevated change risk (scope/ownership shifts).";
        if(meta.status === "CRITICAL") headline = "This signals major change risk (reorg / role impact possible).";
      }

      const now = (() => {
        if(meta.status === "WATCH") return "Core meaning: routine notice; no clear reorg/layoff markers detected.";
        if(meta.status === "HIGH") return "Core meaning: reorg / reporting-line or priority shifts are likely.";
        // CRITICAL
        if(t.includes("roles will be eliminated") || t.includes("impacted employees") || t.includes("reduce workforce") || t.includes("layoff"))
          return "Core meaning: explicit role impact detected — treat as layoff/reorg now.";
        return "Core meaning: strong reorg signals — role impact is plausible.";
      })();

      const next = (() => {
        if(meta.status === "WATCH") return "Next: none implied. If new messages introduce ‘alignment/streamline’ language, reassess.";
        if(meta.status === "HIGH") return "Next: manager-led meetings + role mapping; decisions lock fast.";
        return "Next: decisions lock fast (1–6 weeks). Expect manager meetings, role mapping, and individual notices.";
      })();

      const exposure = (() => {
        if(meta.status === "WATCH") return "Exposure: low from this text alone.";
        if(meta.status === "HIGH") return "Exposure: teams outside “core priorities” + overlapping roles are most at risk.";
        return "Exposure: duplicated functions, non-core teams, and roles tied to “efficiency/streamline” initiatives.";
      })();

      const doNow = (() => {
        if(meta.status === "WATCH") return "Do now: save for context; act only if follow-up messages mention cuts, freezes, or reorg timelines.";
        if(meta.status === "HIGH") return "Do now: ask 3 specifics today — scope change, reporting line, timeline. Document dates.";
        return "Do now: ask 3 specifics today — (1) scope, (2) reporting line, (3) timeline. Update your evidence trail (emails/notes/dates).";
      })();

      return [headline, now, next, exposure, doNow];
    }

    // ---------- Share / History ----------
    function saveHistory(item){
      const key = "apex_history_v1";
      const arr = JSON.parse(localStorage.getItem(key) || "[]");
      arr.unshift(item);
      localStorage.setItem(key, JSON.stringify(arr.slice(0, 50)));
    }
    function readHistory(){
      const key = "apex_history_v1";
      return JSON.parse(localStorage.getItem(key) || "[]");
    }

    // ---------- PDF Extraction ----------
    async function extractTextFromPDF(file){
      if(!file) throw new Error("No file");
      if(!window.pdfjsLib) throw new Error("pdf.js not loaded");
      window.pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.js";

      const buf = await file.arrayBuffer();
      const pdf = await window.pdfjsLib.getDocument({ data: buf }).promise;

      let out = "";
      const maxPages = Math.min(pdf.numPages, 12); // cap to keep it fast on phones
      for(let p=1; p<=maxPages; p++){
        const page = await pdf.getPage(p);
        const content = await page.getTextContent();
        const strings = content.items.map(it => it.str).filter(Boolean);
        const pageText = strings.join(" ").replace(/\s+/g," ").trim();
        if(pageText) out += pageText + "\n\n";
      }
      // cap length
      out = out.trim();
      if(out.length > 20000) out = out.slice(0, 20000);
      return out;
    }

    // ---------- PDF Export ----------
    async function exportVerdictPDF(payload){
      if(!window.jspdf || !window.jspdf.jsPDF) throw new Error("jsPDF not loaded");
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "pt", format: "a4" });

      const margin = 44;
      let y = 54;

      doc.setFont("helvetica","bold");
      doc.setFontSize(16);
      doc.text("APEX Corporate Translator — Verdict", margin, y);
      y += 18;

      doc.setFont("helvetica","normal");
      doc.setFontSize(11);
      doc.setTextColor(80);
      doc.text(`Status: ${payload.status}   |   Confidence: ${payload.conf}   |   Signals: ${payload.signals} (score ${payload.score})`, margin, y);
      doc.setTextColor(0);
      y += 22;

      doc.setFont("helvetica","bold");
      doc.setFontSize(12);
      doc.text("APEX ALERT", margin, y);
      y += 16;

      doc.setFont("helvetica","normal");
      doc.setFontSize(11);
      const alertLines = doc.splitTextToSize(payload.alert, 520);
      doc.text(alertLines, margin, y);
      y += alertLines.length * 14 + 10;

      doc.setFont("helvetica","bold");
      doc.text("Verdict (exactly 5 bullets)", margin, y);
      y += 16;

      doc.setFont("helvetica","normal");
      const bullets = payload.bullets.map((b,i)=> `${i+1}. ${b}`);
      for(const b of bullets){
        const lines = doc.splitTextToSize(b, 520);
        if(y + lines.length*14 > 792){
          doc.addPage();
          y = 54;
        }
        doc.text(lines, margin, y);
        y += lines.length*14 + 8;
      }

      y += 6;
      doc.setFontSize(9);
      doc.setTextColor(120);
      doc.text("Generated locally in your browser. No text is uploaded by this page.", margin, y);

      doc.save("apex-verdict.pdf");
    }

    // ---------- Examples ----------
    const EXAMPLES = [
      {
        title: "CRITICAL — “Operating model” + “streamline”",
        text:
`Subject: Important Update on Our Operating Model
As we navigate a dynamic environment, we’re evaluating opportunities to better align resources with strategic priorities.
Over the coming weeks we will implement organizational adjustments designed to streamline workflows.
Additional details will be shared by your managers as they become available.
Thank you for your continued commitment and adaptability.`
      },
      {
        title: "HIGH — scope/ownership shifts",
        text:
`Subject: Update on team structure
Some teams may see changes in scope, ownership, or reporting structures as part of this process.
Managers will be sharing additional details as plans are finalized.
We appreciate your flexibility as we work through this transition together.`
      },
      {
        title: "WATCH — routine notice",
        text:
`Subject: FYI — Office Closed Friday
Team, reminder that the office will be closed this Friday for scheduled maintenance.
Please work from home if needed. Thanks.`
      }
    ];

    // ---------- Rendering ----------
    let lastResult = null;

    function render(result, bullets){
      $("statusVal").textContent = result.status;
      $("confVal").textContent = result.conf;
      $("sigVal").textContent = String(result.signals);
      $("scoreVal").textContent = result.signals ? `(score ${result.score})` : "";

      setStatusUI(result.status);

      const alert =
        `Status: ${result.status} · Confidence: ${result.conf} · Signals: ${result.signals} (score ${result.score}) — ` +
        (result.status === "WATCH" ? "Low risk / likely informational."
          : result.status === "HIGH" ? "Change risk elevated. Clarify scope + reporting line."
          : "Major change risk. Reorg and/or role impact possible. Act now.");

      $("alertText").textContent = alert;

      const ul = $("bullets");
      ul.innerHTML = "";
      for(const b of bullets){
        const li = document.createElement("li");
        li.textContent = b; // textContent prevents any script printing/executing
        ul.appendChild(li);
      }

      lastResult = { ...result, alert, bullets };
    }

    function computeAndRender(text){
      const clean = normalize(text);
      if(!clean){
        showToast("Paste a message first.");
        return;
      }
      const scored = scoreText(clean);
      const bullets = buildVerdict(clean, scored);
      render(scored, bullets);
      showToast("Verdict generated.");
    }

    // ---------- Wire events ----------
    $("runBtn").addEventListener("click", () => {
      computeAndRender($("input").value);
    });

    $("clearBtn").addEventListener("click", () => {
      $("input").value = "";
      $("pdfFile").value = "";
      $("pdfName").textContent = "No PDF loaded";
      $("pdfStatus").textContent = "—";
      $("statusVal").textContent = "—";
      $("confVal").textContent = "—";
      $("sigVal").textContent = "—";
      $("scoreVal").textContent = "";
      $("badge").textContent = "Status: —";
      $("badge").className = "badge gray";
      $("alertText").textContent = "Paste a message and run APEX to get a verdict.";
      $("bullets").innerHTML = "<li>No verdict yet.</li>";
      lastResult = null;
      showToast("Cleared.");
    });

    $("copyBtn").addEventListener("click", async () => {
      if(!lastResult){ showToast("No verdict to copy."); return; }
      const text =
        `APEX ALERT\n${lastResult.alert}\n\nAPEX VERDICT (5 bullets)\n` +
        lastResult.bullets.map(b => "• " + b).join("\n");
      try{
        await navigator.clipboard.writeText(text);
        showToast("Copied verdict.");
      }catch(e){
        showToast("Copy failed (browser restriction).");
      }
    });

    $("saveBtn").addEventListener("click", () => {
      if(!lastResult){ showToast("No verdict to save."); return; }
      saveHistory({
        ts: Date.now(),
        status: lastResult.status,
        conf: lastResult.conf,
        signals: lastResult.signals,
        score: lastResult.score,
        alert: lastResult.alert,
        bullets: lastResult.bullets
      });
      showToast("Saved to history.");
    });

    $("viewHistoryBtn").addEventListener("click", () => {
      const items = readHistory();
      if(!items.length){ showToast("No history yet."); return; }
      // show latest in modal
      $("modalBackdrop").style.display = "flex";
      const grid = $("exampleGrid");
      grid.innerHTML = "";
      items.slice(0, 12).forEach((it, idx) => {
        const box = document.createElement("div");
        box.className = "ex";
        const title = document.createElement("div");
        title.className = "exTitle";
        const d = new Date(it.ts);
        title.textContent = `${idx+1}. ${it.status} · ${it.conf} · ${it.signals} (score ${it.score}) — ${d.toLocaleString()}`;
        const p = document.createElement("p");
        p.className = "exText";
        p.textContent = it.bullets.map(b=>"• "+b).join("\n");
        box.appendChild(title);
        box.appendChild(p);
        box.addEventListener("click", () => {
          render(it, it.bullets);
          $("modalBackdrop").style.display = "none";
          showToast("Loaded from history.");
        });
        grid.appendChild(box);
      });
    });

    $("shareBtn").addEventListener("click", async () => {
      if(!lastResult){ showToast("Run APEX first."); return; }
      // lightweight share: encode verdict in hash (no server)
      const payload = {
        s: lastResult.status,
        c: lastResult.conf,
        n: lastResult.signals,
        sc: lastResult.score,
        b: lastResult.bullets
      };
      const json = JSON.stringify(payload);
      const encoded = btoa(unescape(encodeURIComponent(json)));
      const url = location.origin + location.pathname + "#v=" + encoded;
      try{
        await navigator.clipboard.writeText(url);
        showToast("Share link copied.");
      }catch(e){
        showToast("Copy failed. Long-press address bar and copy.");
      }
    });

    $("downloadPdfBtn").addEventListener("click", async () => {
      if(!lastResult){ showToast("Run APEX first."); return; }
      try{
        await exportVerdictPDF(lastResult);
        showToast("PDF downloaded.");
      }catch(e){
        console.error(e);
        showToast("PDF export failed.");
      }
    });

    // Examples modal
    function openExamples(){
      $("modalBackdrop").style.display = "flex";
      const grid = $("exampleGrid");
      grid.innerHTML = "";
      EXAMPLES.forEach((ex) => {
        const box = document.createElement("div");
        box.className = "ex";
        const title = document.createElement("div");
        title.className = "exTitle";
        title.textContent = ex.title;
        const p = document.createElement("p");
        p.className = "exText";
        p.textContent = ex.text;
        const btnRow = document.createElement("div");
        btnRow.style.marginTop = "10px";
        const use = document.createElement("button");
        use.className = "btn btnSmall btnPrimary";
        use.textContent = "Use this example";
        use.addEventListener("click", () => {
          $("input").value = ex.text;
          $("modalBackdrop").style.display = "none";
          showToast("Example loaded.");
        });
        btnRow.appendChild(use);
        box.appendChild(title);
        box.appendChild(p);
        box.appendChild(btnRow);
        grid.appendChild(box);
      });
    }
    $("examplesBtn").addEventListener("click", openExamples);
    $("closeModal").addEventListener("click", ()=> $("modalBackdrop").style.display="none");
    $("modalBackdrop").addEventListener("click", (e)=> { if(e.target === $("modalBackdrop")) $("modalBackdrop").style.display="none"; });

    // PDF Upload handling
    $("pdfFile").addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if(!file){
        $("pdfName").textContent = "No PDF loaded";
        $("pdfStatus").textContent = "—";
        return;
      }
      $("pdfName").textContent = file.name;
      $("pdfStatus").textContent = "Extracting…";
      try{
        const text = await extractTextFromPDF(file);
        if(!text){
          $("pdfStatus").textContent = "No text found";
          showToast("PDF has no extractable text.");
          return;
        }
        $("input").value = text;
        $("pdfStatus").textContent = "Loaded";
        showToast("PDF text extracted into the box.");
      }catch(err){
        console.error(err);
        $("pdfStatus").textContent = "Failed";
        showToast("Failed to read PDF.");
      }
    });

    // Load shared hash verdict if present
    function loadFromHash(){
      const h = location.hash || "";
      if(!h.startsWith("#v=")) return;
      try{
        const encoded = h.slice(3);
        const json = decodeURIComponent(escape(atob(encoded)));
        const payload = JSON.parse(json);
        const result = {
          status: payload.s || "—",
          conf: payload.c || "—",
          signals: Number(payload.n || 0),
          score: Number(payload.sc || 0)
        };
        const bullets = Array.isArray(payload.b) ? payload.b.slice(0,5) : ["No verdict."];
        render(result, bullets);
        showToast("Loaded shared verdict.");
      }catch(e){
        console.error(e);
      }
    }
    loadFromHash();
    window.addEventListener("hashchange", loadFromHash);
  </script>
</body>
</html>
