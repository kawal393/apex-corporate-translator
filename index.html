<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>APEX Corporate Translator</title>
  <meta name="description" content="Translate corporate language into consequences — fast verdict, no spin." />
  <style>
    :root{
      --bg:#070a12;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.045);
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.88);
      --muted:rgba(255,255,255,.62);
      --muted2:rgba(255,255,255,.45);
      --good:#36d399;
      --warn:#fbbf24;
      --bad:#ef4444;
      --blue:#3b82f6;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius:20px;
      --radius2:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 800px at 15% 20%, rgba(59,130,246,.20), transparent 60%),
        radial-gradient(1200px 900px at 80% 70%, rgba(34,197,94,.14), transparent 60%),
        radial-gradient(900px 600px at 50% 110%, rgba(249,115,22,.10), transparent 60%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }

    .topbar{
      position:sticky;
      top:0;
      z-index:10;
      backdrop-filter: blur(12px);
      background: linear-gradient(to bottom, rgba(7,10,18,.78), rgba(7,10,18,.40));
      border-bottom:1px solid var(--stroke);
    }
    .topbar-inner{
      max-width:1200px;
      margin:0 auto;
      padding:12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--blue);
      box-shadow: 0 0 16px rgba(59,130,246,.6);
      flex:0 0 auto;
    }
    .brand h1{
      font-size:14px;
      margin:0;
      font-weight:700;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand p{
      margin:0;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }
    .pill .live{
      width:9px;height:9px;border-radius:999px;
      background: var(--good);
      box-shadow: 0 0 16px rgba(54,211,153,.55);
    }

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:18px 16px 28px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr;}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.065), rgba(255,255,255,.035));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-inner{padding:16px 16px 14px;}
    .card h2{
      margin:0 0 6px 0;
      font-size:34px;
      line-height:1.05;
      letter-spacing:-.6px;
    }
    .card .sub{
      margin:0 0 14px 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
    }

    .label{
      font-size:12px;
      letter-spacing:.14em;
      color:var(--muted2);
      text-transform:uppercase;
      margin:12px 0 8px;
    }

    textarea{
      width:100%;
      min-height:160px;
      max-height:340px;
      resize:vertical;
      padding:14px 14px;
      border-radius:var(--radius2);
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.28);
      color:var(--text);
      outline:none;
      font-family: var(--mono);
      font-size:13px;
      line-height:1.45;
    }
    textarea::placeholder{color:rgba(255,255,255,.28)}

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top:10px;
    }

    .file{
      width:100%;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      border-radius: var(--radius2);
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .file-left{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .file-title{font-size:12px;color:var(--muted)}
    .file-note{font-size:12px;color:rgba(255,255,255,.32)}
    .file-right{
      display:flex;
      align-items:center;
      gap:10px;
      flex:0 0 auto;
    }
    input[type="file"]{font-size:12px;color:var(--muted); max-width:220px;}
    .small{
      font-size:12px;
      color:rgba(255,255,255,.32);
    }

    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    button{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:650;
      letter-spacing:.1px;
      font-size:13px;
    }
    button:hover{background: rgba(255,255,255,.09)}
    button.primary{
      border-color: rgba(59,130,246,.45);
      background: linear-gradient(180deg, rgba(59,130,246,.33), rgba(59,130,246,.14));
    }
    button.primary:hover{background: linear-gradient(180deg, rgba(59,130,246,.42), rgba(59,130,246,.16));}
    button.ghost{background: rgba(0,0,0,.18)}
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .stat{
      background: rgba(0,0,0,.20);
      border:1px solid var(--stroke);
      border-radius: var(--radius2);
      padding:10px 12px;
      min-height:70px;
    }
    .stat .k{
      font-size:12px;
      letter-spacing:.14em;
      color:rgba(255,255,255,.38);
      text-transform:uppercase;
    }
    .stat .v{
      margin-top:6px;
      font-size:18px;
      font-weight:750;
      letter-spacing:.2px;
    }

    .alert{
      margin-top:12px;
      padding:12px 12px;
      border-radius: var(--radius2);
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .alert-left{
      display:flex;
      gap:10px;
      align-items:flex-start;
      min-width:0;
    }
    .lamp{
      width:10px;height:10px;border-radius:999px;margin-top:5px;flex:0 0 auto;
      background: var(--warn);
      box-shadow: 0 0 16px rgba(251,191,36,.45);
    }
    .alert h3{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
    }
    .alert p{
      margin:4px 0 0 0;
      font-size:13px;
      color:var(--muted);
      line-height:1.35;
      word-break:break-word;
    }
    .badge{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      flex:0 0 auto;
    }

    .verdict-box{
      margin-top:12px;
      background: rgba(0,0,0,.18);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      overflow:hidden;
    }
    .verdict-head{
      padding:12px 12px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
    }
    .verdict-head .title{
      font-size:12px;
      letter-spacing:.16em;
      color:rgba(255,255,255,.40);
      text-transform:uppercase;
    }

    ul{
      margin:0;
      padding:14px 18px 16px 30px;
      display:flex;
      flex-direction:column;
      gap:10px;
      color:rgba(255,255,255,.88);
      line-height:1.35;
    }
    li{word-break:break-word}

    .footer-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      padding:12px;
      border-top:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
    }
    .hint{
      padding:10px 0 0;
      font-size:12px;
      color:rgba(255,255,255,.34);
    }

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:18px;
      background: rgba(0,0,0,.75);
      border:1px solid rgba(255,255,255,.16);
      color:rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius:999px;
      font-size:12px;
      display:none;
      backdrop-filter: blur(10px);
      z-index:50;
    }

    /* Print PDF export */
    @media print{
      body{background:#fff;color:#000}
      .topbar,.leftCol,.btns,.file,.footer-actions,.pill{display:none!important}
      .card{box-shadow:none;border:1px solid #ddd}
      .wrap{max-width:900px}
      .verdict-box{border:1px solid #ddd}
      ul{color:#000}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="dot"></div>
        <div style="min-width:0">
          <h1>APEX Corporate Translator</h1>
          <p>Translate corporate language into consequences — fast verdict, no spin.</p>
        </div>
      </div>
      <div class="pill"><span class="live"></span> Local • No upload</div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT -->
      <div class="card leftCol">
        <div class="card-inner">
          <h2>Paste the message</h2>
          <p class="sub">Paste an internal email, Slack message, press release, or leadership announcement. For best results, include the headline/subject + opening paragraphs.</p>

          <div class="label">Message</div>
          <textarea id="input" placeholder="Paste corporate email / announcement here..."></textarea>

          <div class="file" style="margin-top:10px;">
            <div class="file-left">
              <div class="file-title"><b>PDF Upload</b></div>
              <div class="file-note">Upload a PDF → we extract text → APEX verdict</div>
            </div>
            <div class="file-right">
              <input id="pdf" type="file" accept="application/pdf" />
              <div id="pdfStatus" class="small">No PDF loaded</div>
            </div>
          </div>

          <div class="row">
            <div class="hint">
              Tip: ruthless triggers include <span style="font-family:var(--mono)">exit</span>, <span style="font-family:var(--mono)">wind down</span>, <span style="font-family:var(--mono)">sunset</span>, <span style="font-family:var(--mono)">portfolio transformation</span>, <span style="font-family:var(--mono)">strategic customers</span>.
            </div>
            <div id="charCount" class="small">0 chars</div>
          </div>

          <div class="btns">
            <button class="primary" id="run">Translate with APEX</button>
            <button class="ghost" id="example">See Real Examples</button>
            <button class="ghost" id="clear">Clear</button>
          </div>

          <div class="hint">Runs locally in your browser. Nothing is uploaded.</div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="card-inner">
          <h2 style="font-size:32px">Verdict</h2>
          <p class="sub">APEX outputs exactly five bullets: what’s happening, why now, what’s next, who’s exposed, what to do.</p>

          <div class="stats">
            <div class="stat">
              <div class="k">Status</div>
              <div class="v" id="statusV">—</div>
            </div>
            <div class="stat">
              <div class="k">Confidence</div>
              <div class="v" id="confV">—</div>
            </div>
            <div class="stat">
              <div class="k">Signals</div>
              <div class="v" id="sigV">—</div>
            </div>
          </div>

          <div class="alert" id="alertBox">
            <div class="alert-left">
              <div class="lamp" id="lamp"></div>
              <div style="min-width:0">
                <h3>APEX ALERT</h3>
                <p id="alertText">Paste a message and run APEX to get a verdict.</p>
              </div>
            </div>
            <div class="badge" id="badge">Status: —</div>
          </div>

          <div class="verdict-box">
            <div class="verdict-head">
              <div class="title">APEX Verdict (exactly 5 bullets)</div>
              <button id="copy">Copy Verdict</button>
            </div>
            <ul id="bullets">
              <li>No verdict yet.</li>
            </ul>

            <div class="footer-actions">
              <button id="pdfOut">Download PDF</button>
              <button id="share">Share Link</button>
              <button id="save">Save History</button>
              <button id="view" class="ghost">View History</button>
            </div>
            <div class="hint" style="padding:0 12px 12px">Generated locally in your browser.</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="toast" id="toast">Copied.</div>

  <!-- PDF.js (client-side, no server) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.min.js"></script>
  <script>
    // ========= Utilities =========
    const $ = (id) => document.getElementById(id);
    const toast = (msg) => {
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(window.__t);
      window.__t = setTimeout(() => t.style.display = "none", 1200);
    };

    // ========= Ruthless patterns =========
    // Terminal decisions are NOT "watch". They are structural.
    const TERMINAL_PATTERNS = [
      /\bexit\b/i,
      /\bwind\s*down\b/i,
      /\bsunset\b/i,
      /\bdiscontinue(d)?\b/i,
      /\bcease\b/i,
      /\bretire\b/i,
      /\bdelist(ed)?\b/i,
      /\bend\s+of\s+(life|support)\b/i,
      /\bshut\s*down\b/i,
      /\bclosure\b/i,
      /\bphase\s*out\b/i
    ];

    const REALLOCATION_PATTERNS = [
      /\bai[-\s]?driven\b/i,
      /\bdata\s*center\b/i,
      /\bfaster[-\s]?growing\s+segments\b/i,
      /\bstrategic\s+customers?\b/i,
      /\bportfolio\s+transformation\b/i,
      /\balignment\b/i,
      /\bredeploy(ment|ed|ing)?\b/i,
      /\bprofitab(le|ility)\b/i,
      /\bsecular\b/i,
      /\bgrowth\s+vectors?\b/i
    ];

    // Common corporate fog (adds weight, but not decisive alone)
    const FOG_PATTERNS = [
      /\bstrategic\s+realign(ment|ing)\b/i,
      /\boperating\s+model\b/i,
      /\bstreamlin(e|ing)\b/i,
      /\boptimi(z|s)(e|ing)\b/i,
      /\bsynerg(y|ies)\b/i,
      /\bright[-\s]?siz(e|ing)\b/i,
      /\btransform(ation|ing)\b/i,
      /\bpriorit(y|ies)\b/i,
      /\brestructure\b/i,
      /\breorg(aniz(e|ation)|)\b/i,
      /\bcost\s+discipline\b/i,
      /\befficien(cy|cies)\b/i
    ];

    const LAYOFF_PATTERNS = [
      /\bredundan(cy|cies)\b/i,
      /\brole\s+impact\b/i,
      /\bposition(s)?\s+eliminated\b/i,
      /\bheadcount\b/i,
      /\bworkforce\b/i,
      /\btransition\b/i,
      /\bseverance\b/i
    ];

    const LEGAL_PATTERNS = [
      /\bforward[-\s]?looking\s+statements?\b/i,
      /\bno\s+duty\s+to\s+update\b/i,
      /\bmaterially\b/i,
      /\brisks?\s+and\s+uncertaint(y|ies)\b/i,
      /\bsec\b/i,
      /\b10-?k\b/i,
      /\b10-?q\b/i
    ];

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function headlineFromText(text){
      const t = (text||"").trim();
      if (!t) return "No input";
      // Prefer first quoted / first line / "Subject:" / "Press Release" headline
      const lines = t.split(/\n+/).map(s=>s.trim()).filter(Boolean);
      const subject = lines.find(l => /^subject:/i.test(l));
      if (subject) return subject.replace(/^subject:\s*/i,"").slice(0,120);
      // Common press release heading
      const pr = lines.find(l => /announces|press release|release|exit|wind down|sunset/i.test(l));
      return (pr || lines[0]).slice(0,120);
    }

    function countHits(text, patterns){
      let hits = 0;
      for (const re of patterns) if (re.test(text)) hits++;
      return hits;
    }

    function analyze(text){
      const t = (text || "").toString();
      const clean = t.replace(/\s+/g, " ").trim();

      const terminalHit = TERMINAL_PATTERNS.some(re => re.test(clean));
      const reallocHit  = REALLOCATION_PATTERNS.some(re => re.test(clean));

      const fogHits    = countHits(clean, FOG_PATTERNS);
      const layoffHits = countHits(clean, LAYOFF_PATTERNS);
      const legalHits  = countHits(clean, LEGAL_PATTERNS);

      // Score model (simple, deterministic)
      // NOTE: Ruthless override is the key: terminal decisions force HIGH/CRITICAL.
      let score = 0;
      let signals = 0;

      if (fogHits){ score += fogHits * 2; signals += Math.min(3, fogHits); }
      if (layoffHits){ score += layoffHits * 3; signals += Math.min(3, layoffHits); }
      if (legalHits){ score += legalHits * 1; signals += Math.min(2, legalHits); }

      if (terminalHit){ score += 9; signals += 3; }      // heavy
      if (reallocHit){ score += 4; signals += 1; }       // support

      // Base status
      let status = "WATCH";
      if (score >= 6) status = "HIGH";
      if (score >= 12) status = "CRITICAL";

      // RUTHLESS OVERRIDE:
      // Terminal decisions are minimum HIGH.
      // Terminal + reallocation = CRITICAL.
      if (terminalHit && status === "WATCH") status = "HIGH";
      if (terminalHit && reallocHit) status = "CRITICAL";

      // Confidence
      // If explicit terminal verbs exist, confidence floor rises.
      let confidence = "Low";
      if (score >= 8) confidence = "Medium";
      if (score >= 14) confidence = "High";
      if (terminalHit && confidence === "Low") confidence = "Medium";

      // Build the 5 bullets (always exactly 5)
      const head = headlineFromText(t);
      let happening = "Informational update; limited direct impact indicated.";
      let whyNow = "Standard comms cycle or routine notice.";
      let whatsNext = "Monitor follow-ups and any scope/timeline changes.";
      let exposed = "Low direct exposure from this text alone.";
      let todo = "Save and document; ask for specifics (scope, timeline, owner).";

      if (status === "HIGH"){
        happening = terminalHit
          ? "A structural move is underway (a line/business is being cut or materially changed)."
          : "Multiple change markers detected; reorg/efficiency action likely.";
        whyNow = terminalHit
          ? "The org is reallocating focus and is closing non-core surface area."
          : "Language suggests pre-execution alignment (efficiency/operating model).";
        whatsNext = terminalHit
          ? "Expect downstream impacts: channel changes, support/warranty shifts, partner updates, internal redeployments."
          : "Expect manager meetings, role mapping, and decisions within 1–6 weeks.";
        exposed = terminalHit
          ? "Teams/products tied to the affected line; channel partners; support operations; adjacent roles."
          : "Duplicated functions, non-core teams, and roles tied to efficiency/streamline initiatives.";
        todo = terminalHit
          ? "Capture the exact decision, dates, and commitments; identify what stops, what continues, and who owns the transition."
          : "Ask 3 specifics today — (1) scope, (2) reporting line, (3) timeline. Document dates/messages.";
      }

      if (status === "CRITICAL"){
        happening = terminalHit
          ? "This is a terminal decision (exit/sunset/wind-down). Not a tweak — an asset is being terminated."
          : "Critical change signal — high probability of restructure with direct role/product impact.";
        whyNow = reallocHit
          ? "Capital is being reallocated to higher-margin/strategic demand (AI/data center language is the tell)."
          : "Leadership is locking a major move and controlling narrative exposure.";
        whatsNext = terminalHit
          ? "Execution phase: supply/support transitions, contractual notices, partner comms, redeployments, and external knock-on effects."
          : "Decisions lock fast (days–weeks). Expect individual notices, reorganizations, and scope cuts.";
        exposed = terminalHit
          ? "Anyone whose revenue, roadmap, or operations depend on the exited line; channel partners; customers relying on continuity."
          : "Duplicated functions, non-core initiatives, and roles tied to ‘efficiency/operating model’ language.";
        todo = terminalHit
          ? "Treat as final: extract commitments in writing, confirm timelines, map dependencies, and build contingencies immediately."
          : "Get scope/timeline in writing; document; prepare contingency; escalate internally if your role is in the blast radius.";
      }

      // Human readable alert line
      const alert = `Status: ${status} · Confidence: ${confidence} · Signals: ${signals} (score ${score}) — `
        + (status === "WATCH"
          ? "Likely informational. Monitor for escalation language."
          : status === "HIGH"
            ? "Change markers detected. Prepare for impact."
            : "Terminal/critical decision language. Act now.");

      return {
        status,
        confidence,
        signals,
        score,
        bullets: [
          `Headline: “${head}” is a ${status} change signal.`,
          `Why now: ${whyNow}`,
          `What’s next: ${whatsNext}`,
          `Who’s exposed: ${exposed}`,
          `What to do: ${todo}`
        ],
        alert
      };
    }

    function setLamp(status){
      const lamp = $("lamp");
      const badge = $("badge");
      if (status === "CRITICAL"){
        lamp.style.background = "var(--bad)";
        lamp.style.boxShadow = "0 0 16px rgba(239,68,68,.55)";
        badge.textContent = "Status: CRITICAL";
      } else if (status === "HIGH"){
        lamp.style.background = "var(--warn)";
        lamp.style.boxShadow = "0 0 16px rgba(251,191,36,.45)";
        badge.textContent = "Status: HIGH";
      } else {
        lamp.style.background = "var(--good)";
        lamp.style.boxShadow = "0 0 16px rgba(54,211,153,.45)";
        badge.textContent = "Status: WATCH";
      }
    }

    function render(result){
      $("statusV").textContent = result.status;
      $("confV").textContent = result.confidence;
      $("sigV").textContent = `${result.signals} (score ${result.score})`;
      $("alertText").textContent = result.alert;
      setLamp(result.status);

      const ul = $("bullets");
      ul.innerHTML = "";
      result.bullets.slice(0,5).forEach(b => {
        const li = document.createElement("li");
        li.textContent = b;
        ul.appendChild(li);
      });

      window.__lastVerdict = result;
    }

    function currentText(){
      return $("input").value || "";
    }

    // ========= History (localStorage) =========
    const KEY = "apex_history_v1";
    function loadHistory(){
      try{ return JSON.parse(localStorage.getItem(KEY) || "[]"); }
      catch{ return []; }
    }
    function saveHistory(item){
      const h = loadHistory();
      h.unshift(item);
      localStorage.setItem(KEY, JSON.stringify(h.slice(0,50)));
    }

    // ========= Share link (compress to URL hash) =========
    function encodeShare(text){
      // lightweight encoding (not cryptographic) to allow sharing text snippet if user chooses
      // If you want "no share of text", comment this out and just share base URL.
      const raw = encodeURIComponent(text);
      return "#t=" + raw;
    }
    function decodeShare(){
      const h = location.hash || "";
      if (h.startsWith("#t=")){
        try{ return decodeURIComponent(h.slice(3)); } catch { return ""; }
      }
      return "";
    }

    // ========= PDF extraction =========
    async function extractPdfText(file){
      const buffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({data: buffer}).promise;
      let out = "";
      const maxPages = Math.min(pdf.numPages, 25); // keep it fast
      for (let p = 1; p <= maxPages; p++){
        const page = await pdf.getPage(p);
        const content = await page.getTextContent();
        const strings = content.items.map(it => it.str).filter(Boolean);
        out += strings.join(" ") + "\n";
      }
      return out.trim();
    }

    // ========= Wire up =========
    $("input").addEventListener("input", () => {
      $("charCount").textContent = `${currentText().length} chars`;
    });

    $("run").addEventListener("click", () => {
      const t = currentText().trim();
      if (!t){ toast("Paste text first."); return; }
      const r = analyze(t);
      render(r);
    });

    $("clear").addEventListener("click", () => {
      $("input").value = "";
      $("charCount").textContent = "0 chars";
      $("pdf").value = "";
      $("pdfStatus").textContent = "No PDF loaded";
      $("statusV").textContent = "—";
      $("confV").textContent = "—";
      $("sigV").textContent = "—";
      $("alertText").textContent = "Paste a message and run APEX to get a verdict.";
      $("badge").textContent = "Status: —";
      $("bullets").innerHTML = "<li>No verdict yet.</li>";
    });

    $("example").addEventListener("click", () => {
      const ex =
`Subject: Operating Model Update
Over the coming weeks we will implement organizational adjustments to streamline execution and align resources to strategic priorities. Some roles may be impacted. Additional details will be shared by your managers as they become available.`;
      $("input").value = ex;
      $("charCount").textContent = `${ex.length} chars`;
      const r = analyze(ex);
      render(r);
      toast("Example loaded.");
    });

    $("copy").addEventListener("click", async () => {
      const r = window.__lastVerdict;
      if (!r){ toast("Run APEX first."); return; }
      const text = r.bullets.join("\n• ").replace(/^/,"• ");
      await navigator.clipboard.writeText(text);
      toast("Copied verdict.");
    });

    $("pdfOut").addEventListener("click", () => {
      const r = window.__lastVerdict;
      if (!r){ toast("Run APEX first."); return; }
      window.print(); // simplest: uses browser print-to-PDF
    });

    $("save").addEventListener("click", () => {
      const t = currentText().trim();
      const r = window.__lastVerdict;
      if (!t || !r){ toast("Run APEX first."); return; }
      saveHistory({
        ts: Date.now(),
        status: r.status,
        confidence: r.confidence,
        signals: r.signals,
        score: r.score,
        headline: r.bullets[0],
        text: t.slice(0, 4000),
        bullets: r.bullets
      });
      toast("Saved to history.");
    });

    $("view").addEventListener("click", () => {
      const h = loadHistory();
      if (!h.length){ toast("No history yet."); return; }
      const pick = h[0];
      $("input").value = pick.text;
      $("charCount").textContent = `${pick.text.length} chars`;
      render({
        status: pick.status,
        confidence: pick.confidence,
        signals: pick.signals,
        score: pick.score,
        bullets: pick.bullets,
        alert: `Status: ${pick.status} · Confidence: ${pick.confidence} · Signals: ${pick.signals} (score ${pick.score}) — Loaded from history.`
      });
      toast("Loaded latest saved item.");
    });

    $("share").addEventListener("click", async () => {
      const t = currentText().trim();
      if (!t){ toast("Paste text first."); return; }
      const url = location.origin + location.pathname + encodeShare(t);
      await navigator.clipboard.writeText(url);
      toast("Share link copied.");
    });

    $("pdf").addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file){ return; }
      $("pdfStatus").textContent = "Reading…";
      try{
        const txt = await extractPdfText(file);
        if (!txt || txt.length < 20){
          $("pdfStatus").textContent = "Failed to read PDF (likely scanned/image-only).";
          toast("PDF text not extractable.");
          return;
        }
        $("input").value = txt;
        $("charCount").textContent = `${txt.length} chars`;
        $("pdfStatus").textContent = "Text extracted.";
        toast("PDF loaded.");
      }catch(err){
        console.error(err);
        $("pdfStatus").textContent = "Failed to read PDF.";
        toast("PDF read failed.");
      }
    });

    // Load shared text if present
    const shared = decodeShare();
    if (shared){
      $("input").value = shared;
      $("charCount").textContent = `${shared.length} chars`;
      const r = analyze(shared);
      render(r);
    }
  </script>
</body>
</html>
